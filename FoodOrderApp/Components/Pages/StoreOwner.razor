@page "/store"
@* @rendermode InteractiveServer *@
@using FoodOrderApp.Models
@using FoodOrderApp.Services
@inject OrderService OrderService
@implements IDisposable

<div class="container mt-4">
    <h2 class="mb-4">🏪 Store Dashboard</h2>

    @if (orders.Any())
    {
        <div class="row">
            @foreach (var order in orders)
            {
                <div class="col-md-4 mb-3">
                    <div class="card @GetCardBorder(order.Status) h-100">
                        <div class="card-header d-flex justify-content-between">
                            <span><strong>Order #@(order.Id.ToString().Substring(0, 6))</strong></span>
                            <span class="badge @GetStatusBadge(order.Status)">
                                @GetStatusText(order.Status)
                            </span>
                        </div>
                        <div class="card-body text-center">
                            <h1 class="display-4 @GetTimerColor(order)">
                                @GetTimeLeft(order)
                            </h1>
                            <p class="text-muted mb-3">@GetStatusMessage(order.Status)</p>

                            @if (order.Status == OrderStatus.Pending)
                            {
                                <button class="btn btn-success btn-lg w-100" @onclick="() => AcceptOrder(order.Id)">
                                    ✅ Accept Order
                                </button>
                            }
                            else if (order.Status == OrderStatus.Processing)
                            {
                                <button class="btn btn-primary btn-lg w-100" @onclick="() => DeliverOrder(order.Id)">
                                    🚚 Mark Delivered
                                </button>
                            }
                            else
                            {
                                <div class="alert alert-success mb-0">
                                    ✔ Completed
                                </div>
                            }
                        </div>
                        <div class="card-footer text-muted text-center">
                            Created: @(order.CreatedAt.ToLocalTime().ToString("HH:mm:ss"))
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <h4 class="text-muted">📭 No orders yet</h4>
            <p>Waiting for customers... </p>
        </div>
    }
</div>

@code {
    private List<Order> orders = new();

    protected override void OnInitialized()
    {
        OrderService.OnOrdersChanged += HandleOrdersChanged;
        RefreshOrders();
    }

    private void HandleOrdersChanged()
    {
        InvokeAsync(() =>
        {
            RefreshOrders();
            StateHasChanged();
        });
    }

    private void RefreshOrders()
    {
        orders = OrderService.GetAllOrders();
    }

    private void AcceptOrder(Guid orderId)
    {
        OrderService.AcceptOrder(orderId);
    }

    private void DeliverOrder(Guid orderId)
    {
        OrderService.UpdateOrderStatus(orderId, OrderStatus.Delivered);
    }

    private string GetTimeLeft(Order order)
    {
        var timeLeft = order.ExpiresAt - DateTime.UtcNow;
        if (timeLeft.TotalSeconds <= 0)
            return "00:00";
        return $"{(int)timeLeft.TotalMinutes:D2}:{(int)timeLeft.Seconds:D2}";
    }

    private string GetStatusBadge(OrderStatus status) => status switch
    {
        OrderStatus.Pending => "bg-warning text-dark",
        OrderStatus.Processing => "bg-info",
        OrderStatus.Delivered => "bg-success",
        _ => "bg-secondary"
    };

    private string GetStatusText(OrderStatus status) => status switch
    {
        OrderStatus.Pending => "⏳ New",
        OrderStatus.Processing => "👨‍🍳 Cooking",
        OrderStatus.Delivered => "✅ Done",
        _ => "Unknown"
    };

    private string GetStatusMessage(OrderStatus status) => status switch
    {
        OrderStatus.Pending => "New order!  Accept before time runs out",
        OrderStatus.Processing => "Preparing food...",
        OrderStatus.Delivered => "Order delivered! ",
        _ => ""
    };

    private string GetCardBorder(OrderStatus status) => status switch
    {
        OrderStatus.Pending => "border-warning",
        OrderStatus.Processing => "border-info",
        OrderStatus.Delivered => "border-success",
        _ => ""
    };

    private string GetTimerColor(Order order)
    {
        var timeLeft = order.ExpiresAt - DateTime.UtcNow;
        if (timeLeft.TotalSeconds <= 10) return "text-danger";
        if (timeLeft.TotalSeconds <= 30) return "text-warning";
        return "text-dark";
    }

    public void Dispose()
    {
        OrderService.OnOrdersChanged -= HandleOrdersChanged;
    }
}